<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Meeting ‚Äî Notetaker</title>
    <link rel="stylesheet" href="/static/components/chat/chat-ui.css" />
    <link rel="stylesheet" href="/static/styles.css" />
    <script src="/static/theme.js"></script>
  </head>
  <body class="meeting-layout">
    <header class="meeting-header">
      <div class="title-row">
        <a href="/" class="app-brand">Notetaker</a>
        <span id="version-badge" class="version-badge">v0.0.0.0</span>
        <input id="meeting-title" type="text" class="meeting-title-inline" placeholder="Untitled meeting" />
        <div id="finalization-status" class="finalization-status-inline" style="display: none;">
          <div class="finalization-spinner small"></div>
          <span id="finalization-status-text">Processing...</span>
        </div>
        <div id="finalization-error-alert" class="finalization-error-alert" style="display: none;">
          <span class="alert-icon">‚ö†Ô∏è</span>
          <span id="finalization-error-text">Finalization failed</span>
          <button id="show-error-details" class="secondary small">Details</button>
        </div>
        <div class="status error inline" id="global-error"></div>
        <div class="status inline" id="global-busy"></div>
        <div class="header-actions">
          <span id="transcription-status-badge" class="status-badge"></span>
          <button id="stop-transcription" class="secondary" style="display: none;">Stop</button>
          <button id="resume-transcription" class="secondary" style="display: none;">Resume</button>
          <button id="export-meeting" class="secondary">Export</button>
          <button id="delete-meeting" class="secondary">Delete</button>
          <div class="notification-center">
            <button id="notification-toggle" class="notification-bell" title="Notifications">
              üîî
              <span id="notification-badge" class="notification-badge">0</span>
            </button>
            <div id="notification-panel" class="notification-panel" style="display: none;">
              <div class="notification-panel-header">
                <h3>Notifications</h3>
                <div class="notification-panel-actions">
                  <button id="mark-all-read">Mark all read</button>
                  <button id="clear-notifications">Clear</button>
                </div>
              </div>
              <div id="notification-list" class="notification-list">
                <div class="notification-empty">No notifications</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </header>

    <div class="meeting-body">
      <!-- Left sidebar: Attendees list -->
      <aside class="meeting-sidebar">
        <div class="sidebar-header">
          <span class="sidebar-title">Attendees</span>
          <span class="auto-rename-status" id="auto-rename-status"></span>
        </div>
        <div class="attendees-list" id="attendees-list">
          <div class="attendees-empty">No attendees detected yet.</div>
        </div>
      </aside>

      <!-- Main content: 2x2 grid -->
      <main class="meeting-main">
        <div class="meeting-grid-2x2" id="meeting-grid">
          <!-- Upper left: Transcript -->
          <section class="grid-panel transcript-panel" data-panel="transcript">
            <div class="grid-panel-header">
              <h2>Transcript</h2>
              <div id="transcript-search-bar" class="chat-search-bar chat-search-bar-inline" style="display:none">
                <input class="chat-search-input" placeholder="Search..." />
                <span class="chat-search-count">0/0</span>
                <button class="chat-search-prev" title="Previous">&#9650;</button>
                <button class="chat-search-next" title="Next">&#9660;</button>
              </div>
              <div class="grid-panel-actions">
                <button id="transcript-search-toggle" class="icon-btn" title="Search transcript">&#128269;</button>
                <button class="panel-maximize-btn icon-btn" title="Maximize">&#x26F6;</button>
              </div>
            </div>
            <div class="status" id="transcript-status">No transcript yet.</div>
            <div class="output transcript" id="transcript-output"></div>
          </section>

          <!-- Upper right: Summary -->
          <section class="grid-panel summary-panel" data-panel="summary">
            <div class="grid-panel-header">
              <h2>Summary</h2>
              <div id="summary-search-bar" class="chat-search-bar chat-search-bar-inline" style="display:none">
                <input class="chat-search-input" placeholder="Search..." />
                <span class="chat-search-count">0/0</span>
                <button class="chat-search-prev" title="Previous">&#9650;</button>
                <button class="chat-search-next" title="Next">&#9660;</button>
              </div>
              <div class="grid-panel-actions">
                <button id="summary-search-toggle" class="icon-btn" title="Search summary">&#128269;</button>
                <button id="manual-summarize" class="secondary small">Summarize</button>
                <button class="panel-maximize-btn icon-btn" title="Maximize">&#x26F6;</button>
              </div>
            </div>
            <div class="status" id="summary-status">Summary will appear here.</div>
            <div class="status" id="manual-summary-status"></div>
            <div class="output" id="summary-output">No summary yet.</div>
          </section>

          <!-- Lower left: Chat -->
          <section class="grid-panel chat-panel" data-panel="chat">
            <div class="grid-panel-header">
              <h2>Chat</h2>
              <div id="meeting-chat-search-bar" class="chat-search-bar chat-search-bar-inline" style="display:none">
                <input class="chat-search-input" placeholder="Search..." />
                <span class="chat-search-count">0/0</span>
                <button class="chat-search-prev" title="Previous">&#9650;</button>
                <button class="chat-search-next" title="Next">&#9660;</button>
              </div>
              <div class="grid-panel-actions">
                <button id="meeting-chat-search-toggle" class="icon-btn" title="Search chat">&#128269;</button>
                <button class="panel-maximize-btn icon-btn" title="Maximize">&#x26F6;</button>
              </div>
            </div>
            <div id="meeting-chat-container" class="chat-container-grid"></div>
          </section>

          <!-- Lower right: Notes -->
          <section class="grid-panel notes-panel" data-panel="notes">
            <div class="grid-panel-header">
              <h2>Notes</h2>
              <div id="notes-search-bar" class="chat-search-bar chat-search-bar-inline" style="display:none">
                <input class="chat-search-input" placeholder="Search..." />
                <span class="chat-search-count">0/0</span>
                <button class="chat-search-prev" title="Previous">&#9650;</button>
                <button class="chat-search-next" title="Next">&#9660;</button>
              </div>
              <div class="grid-panel-actions">
                <button id="notes-search-toggle" class="icon-btn" title="Search notes">&#128269;</button>
                <button class="panel-maximize-btn icon-btn" title="Maximize">&#x26F6;</button>
              </div>
            </div>
            <div class="notes-panel-content">
              <!-- Log of submitted notes -->
              <div class="notes-log" id="notes-log">
                <div class="notes-empty" id="notes-empty">No notes yet. Start typing below.</div>
              </div>
              <!-- Input area -->
              <div class="notes-input-area">
                <div class="notes-timestamp-badge" id="notes-timestamp-badge" style="display: none;">
                  <span id="notes-timestamp-text">Note at 0:00</span>
                </div>
                <div class="notes-input-row">
                  <div class="notes-input-wrapper">
                    <textarea id="notes-input" placeholder="Type a note..." rows="2"></textarea>
                    <button id="notes-clear-btn" class="notes-clear-inline" title="Clear" style="display: none;">&#x2715;</button>
                  </div>
                  <div class="notes-input-buttons">
                    <button id="notes-submit-btn" class="primary small" title="Submit note" disabled>Submit</button>
                  </div>
                </div>
              </div>
            </div>
          </section>
        </div>
      </main>

      <!-- Right sidebar: Debug panel (hidden by default) -->
      <aside class="meeting-debug-sidebar" id="debug-sidebar" style="display: none;">
        <div class="sidebar-header">
          <span class="sidebar-title">Debug</span>
          <button id="close-debug" class="icon-btn" title="Close">&#10005;</button>
        </div>
        <div class="debug-panel-content">
          <div class="row">
            <label>
              <input id="show-raw-segments" type="checkbox" />
              Show raw (unconsolidated) segments
            </label>
          </div>
          <div class="debug-section" id="debug-section-transcript">
            <div class="debug-section-header">
              <h3>Transcription (raw)</h3>
              <button class="debug-maximize-btn icon-btn" title="Maximize">&#x26F6;</button>
            </div>
            <textarea id="manual-transcription" rows="8" readonly></textarea>
          </div>
          <div class="debug-section" id="debug-section-summary">
            <div class="debug-section-header">
              <h3>Summary (raw)</h3>
              <button class="debug-maximize-btn icon-btn" title="Maximize">&#x26F6;</button>
            </div>
            <textarea id="manual-summary" rows="8"></textarea>
          </div>
          <div class="debug-section" id="debug-section-prompt">
            <div class="debug-section-header">
              <h3>Full LLM Prompt</h3>
              <button class="debug-maximize-btn icon-btn" title="Maximize">&#x26F6;</button>
            </div>
            <div class="debug-prompt-path" id="debug-prompt-path"></div>
            <textarea id="debug-prompt-log" rows="8" readonly
              placeholder="Use right-click 'Submit and Log' on the chat send button to capture a prompt."></textarea>
          </div>
        </div>
      </aside>
    </div>

    <!-- Debug toggle button (fixed position, lower right) -->
    <button id="toggle-debug" class="debug-toggle-btn" title="Toggle debug panel">&#128736;</button>

    <!-- Attendee detail popover (positioned next to attendee) -->
    <div class="attendee-detail-popover" id="attendee-detail-popup" style="display: none;">
      <div class="attendee-detail-header">
        <span class="attendee-detail-name" id="attendee-detail-name">Speaker</span>
      </div>
      <div class="attendee-segments" id="attendee-segments">
        <!-- Segments shown when attendee is selected -->
      </div>
    </div>

    <!-- Finalization error details modal -->
    <div id="error-details-modal" class="modal-overlay" style="display:none">
      <div class="modal error-details-modal">
        <div class="modal-header">
          <h3>Finalization Errors</h3>
          <button class="modal-close" id="error-modal-close">&times;</button>
        </div>
        <div class="modal-body">
          <div id="error-list" class="error-list"></div>
          <div id="auto-fix-section" class="auto-fix-section" style="display:none">
            <h4>AI Analysis</h4>
            <div id="auto-fix-content" class="auto-fix-content"></div>
          </div>
          <details class="meeting-json-details">
            <summary>Full Meeting JSON</summary>
            <pre id="meeting-json" class="meeting-json-pre"></pre>
          </details>
        </div>
        <div class="modal-footer">
          <button id="retry-finalization-btn" class="primary">Retry Failed Stages</button>
          <button id="auto-fix-btn" class="secondary">Analyze with AI</button>
        </div>
      </div>
    </div>

    <script>
    // Diagnostic: catch ALL errors on this page
    window.addEventListener('error', function(e) {
      fetch('http://127.0.0.1:7242/ingest/4caeca80-116f-4cf5-9fc0-b1212b4dcd92',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'meeting.html:error_handler',message:'GLOBAL ERROR CAUGHT',data:{message:e.message||'',filename:e.filename||'',lineno:e.lineno||0,colno:e.colno||0,type:e.type||'',errorStr:e.error?String(e.error):''},timestamp:Date.now(),runId:'diag',hypothesisId:'DIAG'})}).catch(function(){});
    });
    // Diagnostic: confirm inline scripts work
    fetch('http://127.0.0.1:7242/ingest/4caeca80-116f-4cf5-9fc0-b1212b4dcd92',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'meeting.html:inline_script',message:'INLINE SCRIPT OK - about to load chat.js and meeting.js',data:{},timestamp:Date.now(),runId:'diag',hypothesisId:'DIAG'})}).catch(function(){});
    </script>
    <script src="/static/notifications.js"></script>
    <script src="/static/components/chat/chat-ui.js?v=1"></script>
    <script>
    fetch('http://127.0.0.1:7242/ingest/4caeca80-116f-4cf5-9fc0-b1212b4dcd92',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'meeting.html:after_chat_js',message:'AFTER chat.js loaded',data:{},timestamp:Date.now(),runId:'diag',hypothesisId:'DIAG'})}).catch(function(){});
    </script>
    <script src="/static/meeting.js?v=182"></script>
    <script>
    fetch('http://127.0.0.1:7242/ingest/4caeca80-116f-4cf5-9fc0-b1212b4dcd92',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'meeting.html:after_meeting_js',message:'AFTER meeting.js loaded',data:{typeof_state:typeof state,typeof_refreshMeeting:typeof refreshMeeting},timestamp:Date.now(),runId:'diag',hypothesisId:'DIAG'})}).catch(function(){});
    </script>
  </body>
</html>
